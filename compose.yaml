# Copyright 2025 Viraj Malia
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Media Server Docker Services

name: media-server
services:
  immich-server:
    container_name: immich_server
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    extends:
      file: hwaccel.transcoding.yml
      service: quicksync
    volumes:
      - ${UPLOAD_LOCATION}:/data
      - /etc/localtime:/etc/localtime:ro
      - ${EXTERNAL_LIB}:/usr/src/app/external
    env_file:
      - .env
    ports:
      - 2283:2283
    depends_on:
      - redis
      - database
    restart: always
    healthcheck:
      disable: false
  immich-machine-learning:
    container_name: immich_machine_learning
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}-openvino
    extends:
      file: hwaccel.ml.yml
      service: openvino
    volumes:
      - model-cache:/cache
    env_file:
      - .env
    restart: always
    healthcheck:
      disable: false
  redis:
    container_name: immich_redis
    image: docker.io/valkey/valkey:8-bookworm@sha256:fea8b3e67b15729d4bb70589eb03367bab9ad1ee89c876f54327fc7c6e618571
    healthcheck:
      test: redis-cli ping || exit 1
    restart: always
  database:
    container_name: immich_postgres
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:8d292bdb796aa58bbbaa47fe971c8516f6f57d6a47e7172e62754feb6ed4e7b0
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_INITDB_ARGS: --data-checksums
    volumes:
      - ${DB_DATA_LOCATION}:/var/lib/postgresql/data
    shm_size: 128mb
    restart: always
  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - CLI_ARGS=
      - SETTINGS_ENCRYPTION_KEY=${SETTINGS_ENCRYPTION_KEY}
      - DUPLICATI__WEBSERVICE_PASSWORD=${DUPLICATI__WEBSERVICE_PASSWORD}
    volumes:
      - ./data/duplicati/config:/config
      - ./data/duplicati/backups:/backups
      - ./data/duplicati/source:/source
      - ${EXTERNAL_LIB}:/immich/external
      - ${UPLOAD_LOCATION}:/immich/uploads
    ports:
      - 8200:8200
    restart: unless-stopped
  plex:
    image: plexinc/pms-docker:${PLEX_VERSION:-latest}
    container_name: plex
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Vancouver
      - PLEX_CLAIM=${PLEX_CLAIM_TOKEN}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./data/plexmediaserver:/config
      - ./data/ssl:/data/plex-ssl
    restart: unless-stopped
  nginx:
    image: nginx:${NGINX_VERSION:-latest}
    ports:
      - 80:80
      - 443:443
    restart: always
    volumes:
      - ./data/immich.conf:/etc/nginx/conf.d/immich.conf
      - ./data/ssl:/etc/nginx/ssl
    depends_on:
      - immich-server
  dockge:
    image: louislam/dockge:1
    restart: unless-stopped
    ports:
      - 5001:5001
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/dockge:/app/data
      - /home/virajm/Documents:/home/virajm/Documents
    environment:
      - DOCKGE_STACKS_DIR=/home/virajm/Documents
volumes:
  model-cache: null
networks: {}
